name: Build Portal Images

on:
  push:
    branches: ['develop']
  workflow_dispatch:
    inputs:
      specific_group:
        description: 'Build specific group (empty for all)'
        required: false
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          LATEST_TAG=$(gh release list --repo mikefarah/yq --limit 1 | cut -f3)
          gh release download $LATEST_TAG --repo mikefarah/yq --pattern 'yq_linux_amd64' --output /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Get matrix
        id: set-matrix
        run: |
          FILTER='to_entries | map(select(.value.plugins != null)) | map({group: .key, plugins: .value.plugins, version: (.value.version // "latest")})'
          if [ "${{ inputs.specific_group }}" != "" ]; then
            FILTER="$FILTER | map(select(.group == \"${{ inputs.specific_group }}\"))"
          fi
          echo "matrix=$(yq -o=j '.groups' groups.yaml | jq -c "{include: ($FILTER)}" | jq -c .include)" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Increased timeout to accommodate retries
    strategy:
      matrix:
        include: ${{ fromJSON(needs.prepare.outputs.matrix) }}
      fail-fast: false
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v4
        with:
          go-version: '1.22'
          cache: false

      - name: Install xportal with retry
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            GOSUMDB=off GOPROXY=direct go install go.lumeweb.com/xportal/cmd/xportal@v0.2.12

      - name: Build portal with retry
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            PLUGINS=$(echo '${{ toJSON(matrix.plugins) }}' | jq -r 'join(" --with ")')
            GOPROXY=direct XPORTAL_DISABLE_CGO=1 PORTAL_VERSION="${{ matrix.version }}" xportal build --with $PLUGINS

      - uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set lowercase names
        id: names
        run: |
          echo "repo=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT
          echo "group=${MATRIX_GROUP,,}" >> $GITHUB_OUTPUT
        env:
          MATRIX_GROUP: ${{ matrix.group }}

      - name: Build and push Docker image with retry
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            docker buildx build \
              --push \
              --cache-from type=gha,scope=${{ matrix.group }} \
              --cache-to type=gha,mode=min,scope=${{ matrix.group }} \
              --tag ghcr.io/${{ steps.names.outputs.repo }}:${{ steps.names.outputs.group }} \
              .